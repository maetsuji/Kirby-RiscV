.data

# Numero de Notas a tocar
# lista de nota,duracao,nota,duracao,nota,duracao,...
DuracaoTitle: 	.word 40,
NotasTitle: 	.half 79,278,79,278,79,278,81,556,79,278,76,278,79,278,84,278,79,834,84,278,84,278,84,278,86,278,84,278,86,278,88,278,79,417,81,139,79,834,79,278,79,278,79,278,81,278,84,278,79,278,76,278,79,278,84,278,79,278,81,278,84,278,86,278,84,278,86,278,84,278,80,278,82,278,79,1112,76,278,77,278

DuracaoHub: 	.word 174, # Grape garden
NotasHub: 	.half 53,183,60,183,67,183,69,183,65,183,48,183,52,183,59,183,66,183,67,183,64,183,47,183,50,183,57,183,64,183,65,183,62,183,47,183,52,183,59,183,66,183,69,183,67,183,52,183,53,183,60,183,67,183,69,183,65,183,48,183,52,183,59,183,66,183,67,183,64,183,47,183,50,183,57,183,64,183,65,183,62,183,60,183,67,183,62,183,55,183,57,183,58,183,59,183,64,549,65,183,67,366,62,1098,60,549,62,183,63,366,58,1098,60,366,62,366,63,366,72,366,70,366,68,366,67,1098,62,1098,64,549,65,183,67,366,62,1098,60,549,62,183,63,366,58,1098,60,366,62,366,63,366,62,732,55,366,60,2196,76,183,76,183,72,183,72,183,69,183,69,183,72,183,72,183,69,183,69,183,76,183,76,183,74,183,74,183,71,183,71,183,67,183,67,183,71,183,71,183,67,183,67,183,74,183,74,183,72,183,72,183,69,183,69,183,65,183,65,183,69,183,69,183,65,183,65,183,72,183,72,183,71,183,71,183,67,183,67,183,64,183,64,183,67,183,67,183,64,183,64,183,70,183,70,183,76,183,76,183,72,183,72,183,69,183,69,183,72,183,72,183,69,183,69,183,76,183,76,183,74,183,74,183,71,183,71,183,67,183,67,183,71,183,71,183,67,183,67,183,74,183,74,183,72,183,72,183,69,183,69,183,65,183,65,183,69,183,69,183,65,183,65,183,74,183,74,183,72,183,72,183,69,183,69,183,72,183,72,183,79,183,74,183,78,183,81,183,79,183,60,183

DuracaoLvl: 	.word 88, # Green greens
NotasLvl: 	.half 79,249,79,83,84,998,84,249,88,83,91,166,96,166,95,166,93,166,91,333,88,249,91,83,89,333,86,249,88,83,86,333,88,249,86,83,84,998,79,249,79,83,84,998,84,249,88,83,91,166,96,166,95,166,93,166,91,333,88,249,91,83,89,333,86,249,88,83,86,333,88,249,86,83,84,1331,84,249,84,83,86,166,88,333,84,166,86,166,84,166,0,500,72,328,71,246,72,82,74,328,72,246,74,82,76,328,74,246,76,82,69,328,69,246,71,82,72,328,71,246,72,82,74,328,72,246,74,82,76,656,81,328,81,246,83,82,84,328,83,246,84,82,86,328,84,246,86,82,88,328,86,246,88,82,81,328,81,246,83,82,84,328,83,246,84,82,86,328,84,246,86,82,83,656,88,656

DuracaoBoss: 	.word 269, # Gourmet race
NotasBoss: 	.half 79,323,77,161,76,161,74,161,71,161,67,323,72,161,74,161,76,161,77,161,74,646,84,646,79,646,76,323,74,323,72,646,72,323,74,323,76,323,72,323,71,323,72,323,67,646,84,646,79,646,76,323,74,323,72,323,72,161,74,161,76,323,77,323,74,323,71,323,72,323,67,323,72,646,84,646,79,646,76,323,74,323,72,646,72,323,74,323,76,323,72,323,71,323,72,323,67,646,84,646,79,646,76,323,77,323,79,323,72,323,74,323,77,323,74,323,71,323,72,1292,53,323,53,323,57,323,60,323,64,323,62,323,60,323,55,323,53,323,53,323,57,323,60,323,64,323,65,323,67,646,81,484,79,161,77,323,76,161,77,161,79,323,72,323,79,646,77,242,77,80,77,161,76,161,74,323,76,161,77,161,76,323,77,323,79,323,76,323,53,323,53,323,57,323,60,323,64,323,62,323,60,323,55,323,53,323,53,323,57,323,60,323,64,323,65,323,67,646,81,484,79,161,77,161,77,80,77,80,81,161,83,161,84,323,79,323,76,323,72,323,74,242,74,80,74,161,77,161,74,161,71,161,67,161,71,161,72,969,71,323, 72,161,72,80,72,80,72,161,74,161,76,161,76,80,76,80,74,161,72,161,71,161,71,80,71,80,71,161,72,161,71,484,72,80,71,80,69,161,69,80,69,80,69,161,71,161,72,161,72,80,72,80,71,161,69,161,67,161,67,80,67,80,67,161,69,161,71,484,69,80,67,80,65,161,65,80,65,80,65,161,67,161,69,161,69,80,69,80,67,161,65,161,64,161,64,80,67,80,72,161,74,161,72,323,67,323,72,161,72,80,72,80,72,161,74,161,75,161,75,80,75,80,77,161,75,161,74,161,74,80,74,80,74,161,75,161,74,484,76,80,74,80,72,161,72,80,72,80,72,161,74,161,76,161,76,80,76,80,74,161,72,161,71,161,71,80,71,80,71,161,72,161,71,484,72,80,71,80,69,161,69,80,69,80,69,161,71,161,72,161,72,80,72,80,71,161,69,161,67,161,67,80,67,80,67,161,69,161,71,484,69,80,67,80,65,161,65,80,65,80,65,161,67,161,69,161,69,80,69,80,72,161,74,161,76,161,76,80,76,80,76,161,79,161,76,161,76,161,74,161,72,161,71,161,74,161,76,161,71,161,74,161,76,161,71,161,74,161,71,161,74,161,76,161,81,161,80,323

DuracaoWin: 	.word 33,
NotasWin:	.half 65,120,67,120,69,120,71,120,69,120,71,120,72,240,67,120,64,360,65,120,67,120,69,120,71,120,69,120,71,120,72,360,64,360,65,120,67,120,69,120,71,120,69,120,71,120,72,240,67,120,64,240,79,120,77,240,76,120,74,240,76,120,72,360,84,360


.text
MusicLoop: # a0, tempo atual em ms
	addi sp,sp,-20
	sw ra,0(sp)
	sw s0,4(sp)
	sw s1,8(sp)
	sw s2,12(sp)
	sw s3,16(sp)

	mv s0,a0
	lw s1,MusicAtual

	IsNoteOver: # checa se a nota atual jï¿½ acabou de tocar
		lw s2,NoteEndTime	# salva o tempo do fim da nota em s2
		beqz s2,PlayNote	# vai pro musicloop se s2 valer 0 (primeira nota da musica)
		#li a7,30		# ecall 30 - TIME - salva em a0 o tempo do programa
		#ecall
		bge s0,s2,PlayNote	# se o tempo atual for maior que o fim da nota, vai pro PlayNote
        	j EndMusicLoop		# vai pro resto do game loop / repete a comparacao do fim da nota
	        
	PlayNote:	
		li a2,0			# define o instrumento	- PIANO
		li a3,64		# define o volume		- 64
		lhu a0,0(s1)		# le o valor da nota
		lhu a1,2(s1)		# le a duracao da nota
		#li a7,31		# define a chamada de syscall
		#ecall			# toca a nota
	
		jal midiOut
	
		#li a7,30		
		#ecall			# ecall 30 - TIME - salva em a0 o tempo do programa
		lw t0,LastGlblTime
		
		lhu t1,2(s1)		# carrega a duracao em milissegundos da nota
		add t1,t1,t0		# soma o tempo atual com a duracao da nota 
		sw t1,NoteEndTime,t6	# salva o valor do fim da nota (valor de s2) em NoteEndTime
	
	
		lw s3,NoteCounter	# carregando o numero da nota atual (valor de NoteCounter) em s3
		lw t0,LenMusAtual	# carregando o numero total de notas
		beq s3,t0,RestartMusic	# comparar se foi a ultima nota (pra loopar a musica)
		
		addi s3,s3,1		# incrementa o contador de notas
		addi s1,s1,4		# incrementa para o endereco da proxima nota
		sw s3,NoteCounter,t6	# salva o valor de t4 no contador de notas (nessa parte do programa, estamos carregando NoteCounter em t0, fazemos t0++, e carregamos de volta o valor)
		j EndMusicLoop		# volta pro teste se a nota acabou
	
	RestartMusic:
		li s3,0
		sw s3,NoteCounter,t6	# zera o NoteCounter
		lw s1,MusicStartAdd	# define o endereco das notas / zera o ponteiro
	
PlaySoundEffect:
	addi sp,sp,-4	
	sw ra,0(sp)
	
	lw t0,LastGlblTime
	
	lw t1,SoundEndTime	# salva o tempo do fim da nota em s2
	beqz t1,PlaySound	# vai pro musicloop se s2 valer 0 (primeira nota da musica)
	bge t0,t1,PlaySound	# se o tempo atual for maior que o fim da nota, vai pro PlayNote
        j EndSound		# vai pro resto do game loop / repete a comparacao do fim da nota
        
PlaySound:
	lw t0,LastGlblTime
	add t0,t0,a1		# soma o tempo atual com a duracao dao som
	sw t0,SoundEndTime,t1	# salva o valor do fim da nota (valor de s2) em NoteEndTime
	
	# a0, valor da nota
	# a1, duracao da nota
	# a2, instrumento
	li a3,64		# define o volume - 64

	jal midiOut
	
	#lw a0,SoundEffectAtual
	#li a7,1
	#ecall
	
	#la a0,endl
	#li a7,4
	#ecall
	#la a0,endl
	#li a7,4
	#ecall
	
EndSound:	
	lw ra,0(sp)
	addi sp,sp,4

	ret
	
EndMusicLoop:
	sw s1,MusicAtual,t0
	
	lw ra,0(sp)
	lw s0,4(sp)
	lw s1,8(sp)
	lw s2,12(sp)
	lw s3,16(sp)
	addi sp,sp,20
	
	ret
	
#############
	
.eqv NoteData           0xFF200178
.eqv NoteClock          0xFF20017C
.eqv NoteMelody         0xFF200180
.eqv MusicTempo         0xFF200184
.eqv MusicAddress       0xFF200188

midiOut:
	DE1(t0,midiOutDE2)
	
	li a7,31		# Chama o ecall normal
	ecall
	j fimmidiOut
	
midiOutDE2:	li      t0, NoteData
    		add     t1, zero, zero

    		# Melody = 0

    		# Definicao do Instrumento
   	 	andi    t2, a2, 0x0000000F
    		slli    t2, t2, 27
    		or      t1, t1, t2

    		# Definicao do Volume
    		andi    t2, a3, 0x0000007F
    		slli    t2, t2, 20
    		or      t1, t1, t2

    		# Definicao do Pitch
    		andi    t2, a0, 0x0000007F
    		slli    t2, t2, 13
    		or      t1, t1, t2

    		# Definicao da Duracao
		li 	t4, 0x1FF
		slli 	t4, t4, 4
		addi 	t4, t4, 0x00F			# t4 = 0x00001FFF
    		and    	t2, a1, t4
    		or      t1, t1, t2

    		# Guarda a definicao da duracao da nota na Word 1
    		j       SintMidOut

SintMidOut:	sw	t1, 0(t0)

	    		# Verifica a subida do clock AUD_DACLRCK para o sintetizador receber as definicoes
	    		li      t2, NoteClock
Check_AUD_DACLRCK:     	lw      t3, 0(t2)
    			beq     t3, zero, Check_AUD_DACLRCK

fimmidiOut:    		ret

